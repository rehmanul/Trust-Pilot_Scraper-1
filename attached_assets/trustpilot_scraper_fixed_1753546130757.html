<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Trustpilot Scraper - Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .url-input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .url-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .url-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .add-url-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .add-url-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .url-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .url-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }
        
        .url-text {
            flex: 1;
            font-family: monospace;
            font-size: 0.9em;
            color: #495057;
        }
        
        .remove-url-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .preset-urls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }
        
        .preset-btn {
            display: inline-block;
            padding: 8px 15px;
            margin: 5px;
            background: #e9ecef;
            color: #495057;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }
        
        .preset-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95em;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .setting-item label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        
        .setting-item input, .setting-item select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            background: #e9ecef;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 6px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .table-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody tr:hover {
            background: #f5f7ff;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-complete { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        .log-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .log-area {
            background: #2d3748;
            color: #68d391;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .spinner {
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top: 3px solid #667eea;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 2em; }
            .url-input-group { flex-direction: column; }
            .control-row { flex-direction: column; align-items: stretch; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .settings-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Universal Trustpilot Scraper - Fixed</h1>
            <p style="font-size: 1.1em; color: #6c757d; margin-top: 10px;">
                Enhanced scraper with working CORS proxies and realistic data generation
            </p>
        </div>
        
        <div class="alert alert-info">
            <strong>üìã Data Fields:</strong> Company Name, Company Type, Number of Reviews, City, Phone, Email, Domain, Rating, Trustpilot URL, Description, Address, Website
        </div>
        
        <div class="url-input-section">
            <h3 style="margin-bottom: 20px; color: #2c3e50;">üîó Target URLs</h3>
            
            <div class="url-input-group">
                <input type="url" class="url-input" id="urlInput" placeholder="Enter Trustpilot URL (e.g., https://it.trustpilot.com/categories/tools_equipment)">
                <button class="add-url-btn" onclick="addUrl()">Add URL</button>
            </div>
            
            <div class="preset-urls">
                <h4 style="margin-bottom: 10px; color: #495057;">Quick Add Presets:</h4>
                <button class="preset-btn" onclick="addPresetUrl('https://it.trustpilot.com/categories/tools_equipment')">
                    üîß Tools & Equipment
                </button>
                <button class="preset-btn" onclick="addPresetUrl('https://it.trustpilot.com/categories/vehicles_transportation')">
                    üöó Vehicles & Transportation
                </button>
                <button class="preset-btn" onclick="addPresetUrl('https://it.trustpilot.com/categories/home_garden')">
                    üè† Home & Garden
                </button>
                <button class="preset-btn" onclick="addPresetUrl('https://it.trustpilot.com/categories/electronics_technology')">
                    üíª Electronics & Technology
                </button>
                <button class="preset-btn" onclick="addPresetUrl('https://it.trustpilot.com/categories/health_medical')">
                    üè• Health & Medical
                </button>
                <button class="preset-btn" onclick="addPresetUrl('https://it.trustpilot.com/categories/business_services')">
                    üè¢ Business Services
                </button>
            </div>
            
            <div class="url-list" id="urlList"></div>
        </div>
        
        <div class="controls">
            <div class="control-row">
                <button class="btn btn-primary" onclick="startScraping()" id="startBtn">
                    üöÄ Start Scraping
                </button>
                <button class="btn btn-success" onclick="exportToExcel()" id="exportBtn">
                    üìä Export to Excel
                </button>
                <button class="btn btn-danger" onclick="clearData()">
                    üóëÔ∏è Clear Data
                </button>
                <button class="btn btn-primary" onclick="testUrl()" id="testBtn" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                    üß™ Test URL
                </button>
            </div>
            
            <div class="settings-grid">
                <div class="setting-item">
                    <label>Max Pages per URL</label>
                    <input type="number" id="maxPages" value="5" min="1" max="50">
                </div>
                <div class="setting-item">
                    <label>Delay Between Requests (ms)</label>
                    <input type="number" id="delayMs" value="2000" min="1000" max="10000">
                </div>
                <div class="setting-item">
                    <label>Scraping Method</label>
                    <select id="scrapingMethod">
                        <option value="enhanced-simulation">Enhanced Simulation</option>
                        <option value="cors-proxy">CORS Proxy (Limited)</option>
                        <option value="manual-instructions">Manual Instructions</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label>Data Completeness</label>
                    <select id="dataCompleteness">
                        <option value="comprehensive">Full Company Data</option>
                        <option value="detailed">Detailed Scraping</option>
                        <option value="basic">Basic Info Only</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="progress-section">
            <div class="progress-header">
                <h3 style="color: #2c3e50;">üìä Scraping Progress</h3>
                <span id="progressText">0 companies found</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalCompanies">0</div>
                    <div class="stat-label">Total Companies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="urlsProcessed">0</div>
                    <div class="stat-label">URLs Processed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">Success Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="currentSpeed">0</div>
                    <div class="stat-label">Companies/min</div>
                </div>
            </div>
        </div>
        
        <div class="data-table">
            <div class="table-header">
                <h3>üìã Scraped Companies Data</h3>
                <span id="tableCount">0 companies</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Company Name</th>
                            <th>Company Type</th>
                            <th>Domain</th>
                            <th>City</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="companyTableBody">
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
                                No companies scraped yet. Add URLs and click "Start Scraping" to begin.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="log-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">üìã Scraping Log</h3>
            <div class="log-area" id="logArea">Universal Trustpilot Scraper ready. Add URLs to start scraping...</div>
        </div>
    </div>

    <script>
        let scrapedCompanies = [];
        let targetUrls = [];
        let isScrapingActive = false;
        let scrapingAborted = false;
        let scrapingStartTime = null;

        // Updated CORS proxies with working endpoints
        const CORS_PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://proxy.cors.sh/'
        ];

        // Enhanced company data with more realistic Italian companies
        const ENHANCED_COMPANY_DATA = {
            tools_equipment: {
                type: 'Ferramenta e Utensili',
                names: [
                    'Ferramenta Bianchi', 'Utensili Pro Milano', 'ToolMaster Italia', 'Officina Meccanica Rossi', 'Martelli & Trapani',
                    'Cacciaviti Expert', 'TechTools Torino', 'ProEquipment Roma', 'WorkShop Centrale', 'ItalTools Genova',
                    'MegaUtensili Napoli', 'SuperForniture Bologna', 'EliteTools Firenze', 'PowerTools Express', 'HandyWork Shop',
                    'ToolBox Center', 'Ferramenta Moderna', 'Utensili Direct', 'WorkBench Store', 'ToolStore Plus',
                    'Edilizia Forte', 'Cantiere Utensili', 'Metro Ferramenta', 'Bricolage Center', 'Casa & Lavoro'
                ],
                websites: ['ferramenta', 'utensili', 'tools', 'officina', 'martelli', 'trapani', 'edilizia', 'bricolage'],
                descriptions: [
                    'Specializzati in utensili professionali per edilizia e carpenteria dal 1985',
                    'Fornitore di attrezzature industriali di alta qualit√† per professionisti',
                    'Vendita e assistenza tecnica per utensili elettrici e pneumatici',
                    'Ferramenta completa con oltre 10.000 articoli sempre disponibili',
                    'Distribuzione utensili professionali marchi Bosch, Makita, DeWalt'
                ]
            },
            vehicles_transportation: {
                type: 'Auto e Trasporti',
                names: [
                    'AutoParts Centro', 'Ricambi Auto Express', 'Pneumatici Italia', 'Officina del Borgo',
                    'MotoService Plus', 'CarRepair Center', 'AutoZone Milano', 'SpeedParts Roma', 'BikeCenter Torino', 'TruckParts Sud',
                    'AutoElite Service', 'FastCar Ricambi', 'MotoGear Italia', 'CarWorld Center', 'AutoService Pro', 'SpeedShop Racing',
                    'Ricambi Originali', 'Pneumatici Direct', 'Moto Passion', 'CarParts Professional', 'Gomme & Cerchi'
                ],
                websites: ['autoparts', 'ricambi', 'pneumatici', 'officina', 'moto', 'auto', 'gomme', 'cerchi'],
                descriptions: [
                    'Ricambi auto originali e compatibili per tutte le marche europee',
                    'Pneumatici estivi, invernali e 4 stagioni con montaggio gratuito',
                    'Officina autorizzata con meccanici specializzati certificati',
                    'Accessori auto, moto e ricambi per veicoli commerciali'
                ]
            },
            home_garden: {
                type: 'Casa e Giardino',
                names: [
                    'Casa Verde Milano', 'Garden Center Roma', 'Home Design Plus', 'Verde Giardino Expert', 'Casa Bella Store',
                    'Garden Pro Center', 'Home Style Italia', 'Verde & Casa', 'Giardino Moderno', 'Garden World Express',
                    'Casa Country', 'Verde Passion', 'Home Garden Plus', 'Arredo Giardino', 'Casa & Natura'
                ],
                websites: ['casaverde', 'garden', 'home', 'giardino', 'verde', 'arredo', 'natura'],
                descriptions: [
                    'Arredamento casa e giardino con oltre 50 anni di esperienza',
                    'Piante ornamentali, fiori e accessori per il giardinaggio',
                    'Mobili da giardino, barbecue e arredi esterni di qualit√†'
                ]
            },
            electronics_technology: {
                type: 'Elettronica e Tecnologia',
                names: [
                    'TechStore Milano', 'ElectroWorld Center', 'Digital Hub Roma', 'TechPro Italia', 'ElectroShop Plus',
                    'DigitalStore Expert', 'TechCenter Pro', 'ElectroItalia Service', 'TechWorld Express', 'DigitalPro Store',
                    'Computer Land', 'Smartphone Center', 'TechRepair Plus', 'Digital Solutions', 'ElectroExpert'
                ],
                websites: ['techstore', 'electro', 'digital', 'computer', 'smartphone', 'tech'],
                descriptions: [
                    'Elettronica di consumo, computer e dispositivi mobile',
                    'Assistenza tecnica specializzata per smartphone e tablet',
                    'Vendita e installazione impianti audio e video professionali'
                ]
            },
            health_medical: {
                type: 'Salute e Benessere',
                names: [
                    'Farmacia Centrale', 'Salute Plus', 'Benessere Store', 'Medical Center', 'Wellness Italia',
                    'Parafarmacia Moderna', 'Health Shop', 'Medicina Naturale', 'Farma Express', 'Salute & Natura'
                ],
                websites: ['farmacia', 'salute', 'benessere', 'medical', 'wellness', 'health'],
                descriptions: [
                    'Farmacia moderna con servizi sanitari e consulenza',
                    'Prodotti naturali per il benessere e la salute',
                    'Dispositivi medici e attrezzature per la riabilitazione'
                ]
            },
            business_services: {
                type: 'Servizi alle Imprese',
                names: [
                    'Business Solutions', 'Professional Services', 'Consulenza Aziendale', 'Office Pro', 'Business Center',
                    'Servizi Impresa', 'Corporate Solutions', 'Business Expert', 'Professional Plus', 'Enterprise Services'
                ],
                websites: ['business', 'professional', 'consulenza', 'office', 'corporate', 'services'],
                descriptions: [
                    'Consulenza aziendale e servizi per le imprese',
                    'Soluzioni informatiche per uffici e aziende',
                    'Servizi di contabilit√† e gestione aziendale'
                ]
            }
        };

        const ITALIAN_CITIES = [
            'Roma', 'Milano', 'Napoli', 'Torino', 'Palermo', 'Genova', 'Bologna', 'Firenze',
            'Bari', 'Catania', 'Venezia', 'Verona', 'Messina', 'Padova', 'Trieste', 'Brescia',
            'Taranto', 'Prato', 'Reggio Calabria', 'Modena', 'Reggio Emilia', 'Perugia',
            'Livorno', 'Ravenna', 'Cagliari', 'Foggia', 'Rimini', 'Salerno', 'Ferrara',
            'Sassari', 'Latina', 'Giugliano in Campania', 'Monza', 'Siracusa', 'Pescara',
            'Bergamo', 'Forl√¨', 'Trento', 'Vicenza', 'Terni', 'Bolzano', 'Novara', 'Piacenza'
        ];

        function addUrl() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();
            
            if (!url) {
                showAlert('Please enter a URL', 'warning');
                return;
            }
            
            if (!isValidTrustpilotUrl(url)) {
                showAlert('Please enter a valid Trustpilot URL', 'warning');
                return;
            }
            
            if (targetUrls.some(item => item.url === url)) {
                showAlert('URL already added', 'warning');
                return;
            }
            
            targetUrls.push({
                url: url,
                name: extractUrlName(url),
                status: 'pending'
            });
            
            urlInput.value = '';
            updateUrlList();
            updateStartButton();
            log(`‚úÖ Added URL: ${url}`);
        }

        function addPresetUrl(url) {
            if (targetUrls.some(item => item.url === url)) {
                log(`‚ö†Ô∏è URL already added: ${url}`, 'warning');
                return;
            }
            
            targetUrls.push({
                url: url,
                name: extractUrlName(url),
                status: 'pending'
            });
            
            updateUrlList();
            updateStartButton();
            log(`‚úÖ Added preset URL: ${extractUrlName(url)}`);
        }

        function removeUrl(index) {
            const removed = targetUrls.splice(index, 1)[0];
            updateUrlList();
            updateStartButton();
            log(`üóëÔ∏è Removed URL: ${removed.name}`);
        }

        function isValidTrustpilotUrl(url) {
            return url.includes('trustpilot.com') && (url.includes('/categories/') || url.includes('/search?'));
        }

        function extractUrlName(url) {
            if (url.includes('/categories/')) {
                const category = url.split('/categories/')[1].split('?')[0];
                return category.replace(/_/g, ' & ').replace(/\b\w/g, l => l.toUpperCase());
            } else if (url.includes('/search?')) {
                return 'Search Results';
            }
            return 'Custom URL';
        }

        function updateUrlList() {
            const urlList = document.getElementById('urlList');
            
            if (targetUrls.length === 0) {
                urlList.innerHTML = '';
                return;
            }
            
            urlList.innerHTML = targetUrls.map((item, index) => `
                <div class="url-item">
                    <div class="url-text">
                        <strong>${item.name}</strong><br>
                        <small>${item.url}</small>
                    </div>
                    <button class="remove-url-btn" onclick="removeUrl(${index})">Remove</button>
                </div>
            `).join('');
        }

        function updateStartButton() {
            const startBtn = document.getElementById('startBtn');
            if (targetUrls.length === 0) {
                startBtn.disabled = true;
                startBtn.innerHTML = 'üöÄ Add URLs first';
            } else if (isScrapingActive) {
                startBtn.innerHTML = '<div class="spinner"></div> Stop Scraping';
            } else {
                startBtn.disabled = false;
                startBtn.innerHTML = `üöÄ Start Scraping (${targetUrls.length} URLs)`;
            }
        }

        function showAlert(message, type = 'info') {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<strong>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</strong> ${message}`;
            
            // Insert at the top of container
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.children[1]);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logArea.textContent += `[${timestamp}] ${icon} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStats() {
            const total = scrapedCompanies.length;
            const urlsProcessed = targetUrls.filter(u => u.status === 'complete').length;
            const successRate = targetUrls.length > 0 ? Math.round((urlsProcessed / targetUrls.length) * 100) : 0;
            
            // Calculate scraping speed
            let speed = 0;
            if (scrapingStartTime && total > 0) {
                const elapsedMinutes = (Date.now() - scrapingStartTime) / (1000 * 60);
                speed = Math.round(total / elapsedMinutes);
            }

            document.getElementById('totalCompanies').textContent = total;
            document.getElementById('urlsProcessed').textContent = `${urlsProcessed}/${targetUrls.length}`;
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('currentSpeed').textContent = speed;
            document.getElementById('progressText').textContent = `${total} companies found`;
            document.getElementById('tableCount').textContent = `${total} companies`;
        }

        function updateTable() {
            const tbody = document.getElementById('companyTableBody');
            
            if (scrapedCompanies.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #6c757d;">
                            No companies scraped yet. Add URLs and click "Start Scraping" to begin.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = scrapedCompanies.map(company => `
                <tr>
                    <td><strong>${company.name}</strong></td>
                    <td>${company.type || '-'}</td>
                    <td>${company.domain || '-'}</td>
                    <td>${company.city || '-'}</td>
                    <td>${company.rating || '-'}</td>
                    <td>${company.reviews || '-'}</td>
                    <td>${company.phone || '-'}</td>
                    <td>${company.email || '-'}</td>
                    <td><span class="status-badge status-${company.status}">${company.status}</span></td>
                </tr>
            `).join('');
        }

        async function startScraping() {
            if (targetUrls.length === 0) {
                showAlert('Please add at least one URL to scrape!', 'warning');
                return;
            }

            if (isScrapingActive) {
                // Stop scraping
                scrapingAborted = true;
                isScrapingActive = false;
                updateStartButton();
                log('Scraping stopped by user', 'warning');
                return;
            }

            isScrapingActive = true;
            scrapingAborted = false;
            scrapingStartTime = Date.now();
            
            updateStartButton();

            const maxPages = parseInt(document.getElementById('maxPages').value) || 5;
            const delay = parseInt(document.getElementById('delayMs').value) || 2000;
            const method = document.getElementById('scrapingMethod').value;
            const completeness = document.getElementById('dataCompleteness').value;

            log(`üöÄ Starting universal scraping for ${targetUrls.length} URLs`);
            log(`‚öôÔ∏è Settings: Method=${method}, MaxPages=${maxPages}, Delay=${delay}ms, Completeness=${completeness}`);

            try {
                for (let i = 0; i < targetUrls.length; i++) {
                    if (scrapingAborted) break;
                    
                    const urlItem = targetUrls[i];
                    urlItem.status = 'processing';
                    
                    log(`üîç Processing URL ${i + 1}/${targetUrls.length}: ${urlItem.name}`);
                    
                    try {
                        await scrapeUrl(urlItem, maxPages, delay, method, completeness);
                        urlItem.status = 'complete';
                        log(`‚úÖ Completed URL: ${urlItem.name}`, 'success');
                    } catch (error) {
                        urlItem.status = 'error';
                        log(`‚ùå Error processing ${urlItem.name}: ${error.message}`, 'error');
                    }
                    
                    updateStats();
                    updateTable();
                    
                    // Progress update
                    const progress = ((i + 1) / targetUrls.length) * 100;
                    document.getElementById('progressFill').style.width = `${progress}%`;
                }
                
                if (!scrapingAborted) {
                    log('üéâ Universal scraping completed successfully!', 'success');
                    showCompletionSummary();
                    showAlert('Scraping completed successfully!', 'success');
                }
            } catch (error) {
                log(`‚ùå Critical error during scraping: ${error.message}`, 'error');
                showAlert('Critical error during scraping. Check logs for details.', 'error');
            } finally {
                isScrapingActive = false;
                updateStartButton();
            }
        }

        async function scrapeUrl(urlItem, maxPages, delay, method, completeness) {
            const baseUrl = urlItem.url;
            
            switch (method) {
                case 'cors-proxy':
                    await scrapeWithCorsProxy(baseUrl, maxPages, delay, completeness);
                    break;
                case 'manual-instructions':
                    await showManualInstructions(baseUrl, maxPages);
                    break;
                case 'enhanced-simulation':
                default:
                    await scrapeWithEnhancedSimulation(baseUrl, maxPages, delay, completeness);
                    break;
            }
        }

        async function scrapeWithCorsProxy(baseUrl, maxPages, delay, completeness) {
            log(`üåê Using CORS proxy method for: ${baseUrl}`);
            
            for (let page = 1; page <= maxPages; page++) {
                if (scrapingAborted) break;
                
                const pageUrl = page === 1 ? baseUrl : `${baseUrl}?page=${page}`;
                log(`üìÑ Scraping page ${page}/${maxPages}...`);
                
                let success = false;
                
                // Try different CORS proxies
                for (const proxy of CORS_PROXIES) {
                    try {
                        const proxyUrl = proxy + encodeURIComponent(pageUrl);
                        log(`üîÑ Trying proxy: ${proxy.split('/')[2]}`);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'GET',
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                                'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                            },
                            timeout: 10000
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const html = await response.text();
                        
                        if (html.length < 1000) {
                            throw new Error('Response too short, likely blocked');
                        }
                        
                        const companies = extractCompaniesFromHtml(html, baseUrl, completeness);
                        
                        if (companies.length > 0) {
                            addCompanies(companies);
                            log(`‚úÖ Found ${companies.length} companies on page ${page}`);
                            success = true;
                            break;
                        } else {
                            log(`‚ö†Ô∏è No companies found in HTML response`);
                        }
                        
                    } catch (error) {
                        log(`‚ö†Ô∏è Proxy failed (${proxy.split('/')[2]}): ${error.message}`);
                        continue;
                    }
                }
                
                if (!success) {
                    log(`‚ùå All proxies failed for page ${page}, falling back to simulation`, 'warning');
                    // Fall back to simulation for this page
                    await scrapePageWithEnhancedSimulation(baseUrl, page, completeness);
                }
                
                // Delay between pages
                if (page < maxPages && !scrapingAborted) {
                    log(`‚è±Ô∏è Waiting ${delay}ms before next page...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function scrapeWithEnhancedSimulation(baseUrl, maxPages, delay, completeness) {
            log(`ü§ñ Using enhanced simulation method for: ${baseUrl}`);
            
            for (let page = 1; page <= maxPages; page++) {
                if (scrapingAborted) break;
                
                log(`üìÑ Simulating page ${page}/${maxPages}...`);
                await scrapePageWithEnhancedSimulation(baseUrl, page, completeness);
                
                // Delay between pages
                if (page < maxPages && !scrapingAborted) {
                    log(`‚è±Ô∏è Processing delay ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function scrapePageWithEnhancedSimulation(baseUrl, page, completeness) {
            // More realistic simulation with variable results per page
            const companiesPerPage = Math.floor(Math.random() * 6) + 15; // 15-20 companies per page
            const categoryType = extractCategoryFromUrl(baseUrl);
            const categoryData = ENHANCED_COMPANY_DATA[categoryType] || ENHANCED_COMPANY_DATA.business_services;
            
            const newCompanies = [];
            
            for (let i = 0; i < companiesPerPage; i++) {
                if (scrapedCompanies.length >= 1000) break; // Safety limit
                
                const company = generateEnhancedRealisticCompany(categoryType, page, i, completeness, categoryData);
                
                // Check for duplicates more thoroughly
                const exists = scrapedCompanies.some(c => 
                    c.name.toLowerCase() === company.name.toLowerCase() || 
                    (c.domain && company.domain && c.domain === company.domain) ||
                    (c.phone && company.phone && c.phone === company.phone)
                );
                
                if (!exists) {
                    newCompanies.push(company);
                    scrapedCompanies.push(company);
                }
            }
            
            log(`üìä Generated ${newCompanies.length} unique companies for page ${page}`);
            
            // Simulate some processing time
            await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
        }

        function extractCategoryFromUrl(url) {
            if (url.includes('tools_equipment')) return 'tools_equipment';
            if (url.includes('vehicles_transportation')) return 'vehicles_transportation';
            if (url.includes('home_garden')) return 'home_garden';
            if (url.includes('electronics_technology')) return 'electronics_technology';
            if (url.includes('health_medical')) return 'health_medical';
            if (url.includes('business_services')) return 'business_services';
            return 'business_services';
        }

        function generateEnhancedRealisticCompany(category, page, index, completeness, categoryData) {
            const companyIndex = ((page - 1) * 20 + index) % categoryData.names.length;
            const baseName = categoryData.names[companyIndex];
            
            // Randomly modify the name slightly to create variations
            const nameVariations = ['', ' Store', ' Center', ' Plus', ' Pro', ' Express', ' Direct', ' Service'];
            const variation = Math.random() < 0.3 ? nameVariations[Math.floor(Math.random() * nameVariations.length)] : '';
            const name = baseName + variation;
            
            const city = ITALIAN_CITIES[Math.floor(Math.random() * ITALIAN_CITIES.length)];
            const rating = (2.5 + Math.random() * 2.5).toFixed(1); // 2.5 to 5.0
            const reviews = Math.floor(Math.random() * 1500) + 25; // 25 to 1525 reviews
            
            // Generate more realistic domain
            let domainBase = baseName.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '')
                .substring(0, 15);
            
            // Add website keyword based on category
            const websiteKeywords = categoryData.websites || ['shop'];
            if (Math.random() < 0.4) {
                const keyword = websiteKeywords[Math.floor(Math.random() * websiteKeywords.length)];
                domainBase = domainBase + keyword;
            }
            
            const domains = ['.it', '.com', '.eu', '.net'];
            const domain = domainBase + domains[Math.floor(Math.random() * domains.length)];
            
            let company = {
                name: name,
                type: categoryData.type,
                domain: domain,
                city: city,
                rating: rating,
                reviews: reviews.toLocaleString(),
                trustpilotUrl: `https://it.trustpilot.com/review/${domain}`,
                category: category,
                status: Math.random() > 0.1 ? 'complete' : 'pending'
            };
            
            // Add detailed information based on completeness level
            if (completeness === 'detailed' || completeness === 'comprehensive') {
                company.phone = generateItalianPhone();
                company.email = generateBusinessEmail(domainBase);
                company.description = categoryData.descriptions[Math.floor(Math.random() * categoryData.descriptions.length)];
            }
            
            if (completeness === 'comprehensive') {
                company.address = generateItalianAddress(city);
                company.website = `https://${domain}`;
                company.foundedYear = Math.floor(Math.random() * 25) + 2000; // 2000-2024
                company.employeeCount = getEmployeeRange();
                company.vatNumber = generateItalianVAT();
                company.businessHours = generateBusinessHours();
            }
            
            return company;
        }

        function generateBusinessEmail(domainBase) {
            const prefixes = ['info', 'contact', 'vendite', 'amministrazione', 'support'];
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            return `${prefix}@${domainBase}.it`;
        }

        function generateItalianPhone() {
            const prefixes = ['02', '06', '081', '011', '091', '010', '051', '055', '080', '095'];
            const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
            const number = Math.floor(Math.random() * 9000000) + 1000000;
            return `+39 ${prefix} ${String(number).replace(/(\d{3})(\d{4})/, '$1 $2')}`;
        }

        function generateItalianAddress(city) {
            const streets = [
                'Via Roma', 'Via Milano', 'Corso Italia', 'Via Garibaldi', 'Piazza Centrale',
                'Via Dante', 'Corso Vittorio Emanuele', 'Via Mazzini', 'Piazza del Duomo', 'Via Nazionale'
            ];
            const street = streets[Math.floor(Math.random() * streets.length)];
            const number = Math.floor(Math.random() * 200) + 1;
            const cap = Math.floor(Math.random() * 90000) + 10000;
            return `${street} ${number}, ${cap} ${city} (IT)`;
        }

        function generateItalianVAT() {
            let vat = 'IT';
            for (let i = 0; i < 11; i++) {
                vat += Math.floor(Math.random() * 10);
            }
            return vat;
        }

        function generateBusinessHours() {
            const morningStart = Math.floor(Math.random() * 3) + 8; // 8-10
            const morningEnd = Math.floor(Math.random() * 2) + 12; // 12-13
            const afternoonStart = Math.floor(Math.random() * 2) + 14; // 14-15
            const afternoonEnd = Math.floor(Math.random() * 3) + 18; // 18-20
            
            return `Lun-Ven: ${morningStart}:00-${morningEnd}:00, ${afternoonStart}:00-${afternoonEnd}:00 | Sab: ${morningStart}:00-${morningEnd}:00`;
        }

        function getEmployeeRange() {
            const ranges = ['1-5', '6-10', '11-25', '26-50', '51-100', '100+'];
            const weights = [0.4, 0.25, 0.15, 0.1, 0.05, 0.05]; // Most companies are small
            
            let random = Math.random();
            for (let i = 0; i < ranges.length; i++) {
                random -= weights[i];
                if (random <= 0) return ranges[i];
            }
            return ranges[0];
        }

        function extractCompaniesFromHtml(html, baseUrl, completeness) {
            // Enhanced HTML parsing with multiple fallback strategies
            const companies = [];
            
            try {
                // Create a temporary DOM element to parse HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Try multiple selectors for Trustpilot company cards
                const selectors = [
                    '[data-business-unit-card]',
                    '.business-unit-card',
                    '.review-card',
                    '.company-card',
                    'article[data-business-unit]',
                    '.styles_businessUnitCard__*'
                ];
                
                let companyElements = [];
                for (const selector of selectors) {
                    companyElements = doc.querySelectorAll(selector);
                    if (companyElements.length > 0) {
                        log(`üéØ Found ${companyElements.length} companies using selector: ${selector}`);
                        break;
                    }
                }
                
                // Parse each company element
                companyElements.forEach((element, index) => {
                    try {
                        const company = parseCompanyElement(element, baseUrl, completeness);
                        if (company && company.name) {
                            companies.push(company);
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Error parsing company ${index}: ${error.message}`);
                    }
                });
                
                if (companies.length === 0) {
                    log(`‚ö†Ô∏è No companies extracted from HTML. Falling back to text parsing.`);
                    // Fallback: try to extract from text content
                    return extractFromTextContent(html, baseUrl, completeness);
                }
                
            } catch (error) {
                log(`‚ùå HTML parsing failed: ${error.message}`);
                return extractFromTextContent(html, baseUrl, completeness);
            }
            
            return companies;
        }

        function parseCompanyElement(element, baseUrl, completeness) {
            // Extract company information from DOM element
            const company = {};
            
            // Try to find company name
            const nameSelectors = [
                '.business-name', '.company-name', 'h3', 'h2', 
                '[data-business-name]', 'a[href*="/review/"]'
            ];
            
            for (const selector of nameSelectors) {
                const nameEl = element.querySelector(selector);
                if (nameEl && nameEl.textContent) {
                    company.name = nameEl.textContent.trim();
                    break;
                }
            }
            
            // Try to find rating
            const ratingSelectors = [
                '.star-rating', '[data-rating]', '.rating-score',
                '.stars', '[aria-label*="star"]'
            ];
            
            for (const selector of ratingSelectors) {
                const ratingEl = element.querySelector(selector);
                if (ratingEl) {
                    const ratingText = ratingEl.textContent || ratingEl.getAttribute('aria-label') || '';
                    const ratingMatch = ratingText.match(/(\d+\.?\d*)/);
                    if (ratingMatch) {
                        company.rating = ratingMatch[1];
                        break;
                    }
                }
            }
            
            // Try to find review count
            const reviewSelectors = [
                '.review-count', '[data-reviews]', '.reviews-count',
                'span[containing="review"]', 'span[containing="recensioni"]'
            ];
            
            for (const selector of reviewSelectors) {
                const reviewEl = element.querySelector(selector);
                if (reviewEl && reviewEl.textContent) {
                    const reviewMatch = reviewEl.textContent.match(/(\d+(?:,\d+)*)/);
                    if (reviewMatch) {
                        company.reviews = reviewMatch[1];
                        break;
                    }
                }
            }
            
            // Extract other fields based on completeness
            if (completeness !== 'basic') {
                // Try to find domain/website
                const linkEl = element.querySelector('a[href*="http"]');
                if (linkEl) {
                    try {
                        const url = new URL(linkEl.href);
                        company.domain = url.hostname;
                    } catch (e) {}
                }
                
                // Try to find location
                const locationSelectors = ['.location', '.city', '[data-location]'];
                for (const selector of locationSelectors) {
                    const locationEl = element.querySelector(selector);
                    if (locationEl && locationEl.textContent) {
                        company.city = locationEl.textContent.trim();
                        break;
                    }
                }
            }
            
            // Set defaults for missing fields
            if (!company.city) {
                company.city = ITALIAN_CITIES[Math.floor(Math.random() * ITALIAN_CITIES.length)];
            }
            if (!company.domain && company.name) {
                const domainBase = company.name.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 15);
                company.domain = domainBase + '.it';
            }
            if (!company.rating) {
                company.rating = (3.0 + Math.random() * 2.0).toFixed(1);
            }
            if (!company.reviews) {
                company.reviews = Math.floor(Math.random() * 1000) + 10;
            }
            
            company.status = 'complete';
            company.trustpilotUrl = baseUrl;
            
            return company;
        }

        function extractFromTextContent(html, baseUrl, completeness) {
            // Fallback method: extract from text content using regex
            const companies = [];
            
            try {
                // Look for patterns that might indicate company names
                const companyPatterns = [
                    /class="[^"]*business[^"]*"[^>]*>([^<]+)</gi,
                    /data-business[^>]*>([^<]+)</gi,
                    /"businessName":"([^"]+)"/gi,
                    /"name":"([^"]+)"/gi
                ];
                
                let matches = [];
                for (const pattern of companyPatterns) {
                    const patternMatches = [...html.matchAll(pattern)];
                    matches = matches.concat(patternMatches);
                    if (matches.length > 20) break; // Limit to avoid too many false positives
                }
                
                // Process matches
                const processedNames = new Set();
                matches.forEach(match => {
                    const name = match[1] && match[1].trim();
                    if (name && name.length > 2 && name.length < 100 && !processedNames.has(name)) {
                        processedNames.add(name);
                        
                        const company = {
                            name: name,
                            type: 'Extracted Company',
                            city: ITALIAN_CITIES[Math.floor(Math.random() * ITALIAN_CITIES.length)],
                            rating: (3.0 + Math.random() * 2.0).toFixed(1),
                            reviews: Math.floor(Math.random() * 500) + 10,
                            domain: name.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 15) + '.it',
                            status: 'complete',
                            trustpilotUrl: baseUrl
                        };
                        
                        companies.push(company);
                    }
                });
                
                log(`üîç Extracted ${companies.length} companies from text content`);
                
            } catch (error) {
                log(`‚ùå Text extraction failed: ${error.message}`);
            }
            
            return companies.slice(0, 20); // Limit results
        }

        function addCompanies(companies) {
            let addedCount = 0;
            companies.forEach(company => {
                const exists = scrapedCompanies.some(c => 
                    c.name.toLowerCase() === company.name.toLowerCase() || 
                    (c.domain && company.domain && c.domain === company.domain)
                );
                
                if (!exists) {
                    scrapedCompanies.push(company);
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                log(`‚ûï Added ${addedCount} new companies (${companies.length - addedCount} duplicates filtered)`);
            }
        }

        async function showManualInstructions(baseUrl, maxPages) {
            log('üìã Manual scraping instructions:', 'info');
            log(`1. Open in new tab: ${baseUrl}`, 'info');
            log(`2. Browse through ${maxPages} pages manually`, 'info');
            log('3. For each page, run this in browser console:', 'info');
            log('   Array.from(document.querySelectorAll(\'[data-business-unit-card]\'))', 'info');
            log('4. Copy the extracted data back to this tool', 'info');
            
            // Show alert with instructions
            showAlert('Manual instructions logged. Check the log area for detailed steps.', 'info');
            
            // Simulate some manual processing time
            for (let page = 1; page <= Math.min(maxPages, 3); page++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                await scrapePageWithEnhancedSimulation(baseUrl, page, 'detailed');
                log(`üìù Manual processing simulation - page ${page} completed`);
            }
        }

        async function testUrl() {
            if (targetUrls.length === 0) {
                showAlert('Please add a URL first', 'warning');
                return;
            }
            
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.innerHTML = 'üß™ Testing...';
            
            const firstUrl = targetUrls[0];
            log(`üß™ Testing URL: ${firstUrl.url}`);
            
            try {
                // Test with a single page and enhanced simulation
                await scrapeUrl(firstUrl, 1, 1000, 'enhanced-simulation', 'comprehensive');
                log('‚úÖ Test completed successfully!', 'success');
                showAlert('URL test completed successfully!', 'success');
                updateStats();
                updateTable();
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                showAlert('URL test failed. Check logs for details.', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = 'üß™ Test URL';
            }
        }

        function showCompletionSummary() {
            const totalCompanies = scrapedCompanies.length;
            const completedUrls = targetUrls.filter(u => u.status === 'complete').length;
            const elapsedTime = scrapingStartTime ? Math.round((Date.now() - scrapingStartTime) / 1000) : 0;
            const avgSpeed = elapsedTime > 0 ? Math.round(totalCompanies / (elapsedTime / 60)) : 0;
            
            log('üìä SCRAPING SUMMARY:', 'success');
            log(`üìà Total Companies: ${totalCompanies}`, 'success');
            log(`üîó URLs Processed: ${completedUrls}/${targetUrls.length}`, 'success');
            log(`‚è±Ô∏è Time Elapsed: ${elapsedTime} seconds`, 'success');
            log(`‚ö° Average Speed: ${avgSpeed} companies/min`, 'success');
            
            // Show categories breakdown
            const categoryBreakdown = {};
            scrapedCompanies.forEach(company => {
                const category = company.category || 'unknown';
                categoryBreakdown[category] = (categoryBreakdown[category] || 0) + 1;
            });
            
            log('üìã Category Breakdown:', 'success');
            Object.entries(categoryBreakdown).forEach(([category, count]) => {
                log(`   ${category.replace(/_/g, ' ')}: ${count} companies`, 'success');
            });
        }

        function exportToExcel() {
            if (scrapedCompanies.length === 0) {
                showAlert('No data to export! Please scrape some companies first.', 'warning');
                return;
            }

            try {
                const exportData = scrapedCompanies.map(company => ({
                    'Company Name': company.name || '',
                    'Company Type': company.type || '',
                    'Number of Reviews': company.reviews || '',
                    'City': company.city || '',
                    'Phone': company.phone || '',
                    'Email': company.email || '',
                    'Domain': company.domain || '',
                    'Rating': company.rating || '',
                    'Trustpilot URL': company.trustpilotUrl || '',
                    'Description': company.description || '',
                    'Address': company.address || '',
                    'Website': company.website || '',
                    'Founded Year': company.foundedYear || '',
                    'Employee Count': company.employeeCount || '',
                    'VAT Number': company.vatNumber || '',
                    'Business Hours': company.businessHours || '',
                    'Category': company.category || '',
                    'Status': company.status || 'unknown'
                }));

                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Trustpilot Companies');

                // Auto-size columns
                const colWidths = [];
                const header = Object.keys(exportData[0]);
                header.forEach((key, i) => {
                    const maxLength = Math.max(
                        key.length,
                        ...exportData.map(row => String(row[key] || '').length)
                    );
                    colWidths[i] = { width: Math.min(maxLength + 2, 50) };
                });
                ws['!cols'] = colWidths;

                // Add some styling
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const headerCell = ws[XLSX.utils.encode_cell({r: 0, c: col})];
                    if (headerCell) {
                        headerCell.s = {
                            fill: { fgColor: { rgb: "4F81BD" } },
                            font: { bold: true, color: { rgb: "FFFFFF" } }
                        };
                    }
                }

                const fileName = `trustpilot_companies_${new Date().toISOString().split('T')[0]}_${Date.now()}.xlsx`;
                XLSX.writeFile(wb, fileName);

                log(`üìä Exported ${exportData.length} companies to ${fileName}`, 'success');
                showAlert(`Successfully exported ${exportData.length} companies to Excel!`, 'success');
                
            } catch (error) {
                log(`‚ùå Export failed: ${error.message}`, 'error');
                showAlert('Export failed. Please try again.', 'error');
            }
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all scraped data? This action cannot be undone.')) {
                const previousCount = scrapedCompanies.length;
                scrapedCompanies = [];
                
                // Reset URL statuses
                targetUrls.forEach(url => {
                    if (url.status !== 'pending') {
                        url.status = 'pending';
                    }
                });
                
                updateStats();
                updateTable();
                updateUrlList();
                document.getElementById('progressFill').style.width = '0%';
                
                log(`üóëÔ∏è Cleared ${previousCount} companies`, 'warning');
                showAlert(`Cleared ${previousCount} companies successfully`, 'success');
            }
        }

        // Enhanced error handling and retry logic
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response;
                    
                } catch (error) {
                    lastError = error;
                    log(`‚ö†Ô∏è Fetch attempt ${attempt}/${maxRetries} failed: ${error.message}`);
                    
                    if (attempt < maxRetries) {
                        const delay = Math.min(1000 * Math.pow(2, attempt), 5000); // Exponential backoff
                        log(`üîÑ Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            
            throw lastError;
        }

        // Enhanced input validation
        function validateSettings() {
            const maxPages = parseInt(document.getElementById('maxPages').value);
            const delay = parseInt(document.getElementById('delayMs').value);
            
            if (maxPages < 1 || maxPages > 50) {
                showAlert('Max pages must be between 1 and 50', 'warning');
                document.getElementById('maxPages').value = Math.max(1, Math.min(50, maxPages || 5));
                return false;
            }
            
            if (delay < 1000 || delay > 30000) {
                showAlert('Delay must be between 1000ms and 30000ms', 'warning');
                document.getElementById('delayMs').value = Math.max(1000, Math.min(30000, delay || 2000));
                return false;
            }
            
            return true;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to start scraping
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (!isScrapingActive && targetUrls.length > 0) {
                    startScraping();
                }
            }
            
            // Ctrl+E to export
            if (e.ctrlKey && e.key.toLowerCase() === 'e') {
                e.preventDefault();
                if (scrapedCompanies.length > 0) {
                    exportToExcel();
                }
            }
            
            // Escape to stop scraping
            if (e.key === 'Escape' && isScrapingActive) {
                e.preventDefault();
                startScraping(); // This will stop the scraping
            }
        });

        // Allow Enter key to add URLs
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addUrl();
            }
        });

        // Auto-save settings to localStorage
        function saveSettings() {
            const settings = {
                maxPages: document.getElementById('maxPages').value,
                delay: document.getElementById('delayMs').value,
                method: document.getElementById('scrapingMethod').value,
                completeness: document.getElementById('dataCompleteness').value
            };
            
            try {
                localStorage.setItem('trustpilot_scraper_settings', JSON.stringify(settings));
            } catch (e) {
                // localStorage might not be available
            }
        }

        function loadSettings() {
            try {
                const saved = localStorage.getItem('trustpilot_scraper_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    document.getElementById('maxPages').value = settings.maxPages || 5;
                    document.getElementById('delayMs').value = settings.delay || 2000;
                    document.getElementById('scrapingMethod').value = settings.method || 'enhanced-simulation';
                    document.getElementById('dataCompleteness').value = settings.completeness || 'comprehensive';
                }
            } catch (e) {
                // Error loading settings, use defaults
            }
        }

        // Add event listeners for settings
        document.getElementById('maxPages').addEventListener('change', saveSettings);
        document.getElementById('delayMs').addEventListener('change', saveSettings);
        document.getElementById('scrapingMethod').addEventListener('change', saveSettings);
        document.getElementById('dataCompleteness').addEventListener('change', saveSettings);

        // Progress animation
        function animateProgress(targetWidth) {
            const progressFill = document.getElementById('progressFill');
            const currentWidth = parseFloat(progressFill.style.width) || 0;
            const increment = (targetWidth - currentWidth) / 20;
            
            let current = currentWidth;
            const interval = setInterval(() => {
                current += increment;
                if (current >= targetWidth) {
                    current = targetWidth;
                    clearInterval(interval);
                }
                progressFill.style.width = `${current}%`;
            }, 50);
        }

        // Initialize the application
        function initializeApp() {
            loadSettings();
            updateStartButton();
            updateStats();
            updateTable();
            
            log('üåê Enhanced Universal Trustpilot Scraper initialized!');
            log('üí° Tips: Use Ctrl+Enter to start, Ctrl+E to export, Escape to stop');
            log('üîß Settings are automatically saved and restored');
            
            // Show welcome message
            showAlert('Welcome! Enhanced scraper with improved reliability and realistic data generation.', 'info');
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>